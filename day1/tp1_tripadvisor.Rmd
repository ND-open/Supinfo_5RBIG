---
title: "TP1 - étude des données Trip Advisor et modélisation des notes"
output: 
  html_document:
          toc: yes
---

```{r load pkg}
# install packages if not here
pkgs <- c("dplyr", "ggplot2", "forcats")
for(pkg in pkgs){
  if(! suppressPackageStartupMessages( require(pkg, character.only = TRUE) ) ){
    install.packages(pkg, character.only = TRUE)
  }
}

# Chargement des lib
suppressPackageStartupMessages( library(dplyr) )
suppressPackageStartupMessages( library(ggplot2) )
library(forcats)
```

Plan proposé : 

* 1) Study the different categorical variables: frequencies, proportions, charts.

* 2) Study the different quantitative variables:  descriptives statistics, charts.

* 3) Study associations between categorical variables.

* 4) Study associations between quantitative variables and categorical variables.

* 5) Perform t-tests to compare pairwise the rating or the number of reviews of some cities.

* 6) Perform an ANOVA to compare the rating or the number of reviews depending on the city. 


## TRIPADVISOR usecase

Analyse des variables (types).

```{r ways to load data}
# getwd()
# dfr <- utils::read.csv("Tripadvisor.csv")
# dfr2 <- readr::read_csv("Tripadvisor.csv")
# dfr3 <- data.table::fread("Tripadvisor.csv", header = TRUE)
```
```{r benchmark}
# res <- microbenchmark::microbenchmark(utils::read.csv("Tripadvisor.csv"),
#                                readr::read_csv("Tripadvisor.csv"),
#                                data.table::fread("Tripadvisor.csv", header = TRUE),
#                                vroom::vroom("Tripadvisor.csv", delim = ",", col_names = TRUE), times = 10
# )

# knitr::kable(res)
# saveRDS(res, "load_data_benchmark.rds")
# res <- readRDS("load_data_benchmark.rds")
# knitr::kable(res)
# summary(res)
```


```{r data load, warning=FALSE}
dfr <- vroom::vroom("Tripadvisor.csv", delim = ",", col_names = TRUE)
dfr
```


```{r glimpse}
# str(dfr)
dfr %>% glimpse()
```


```{r select character}
dfr %>% 
        select_if(is.character)
```

Conversion des chaine des caractère en facteurs.

```{r convert to factor}
df_clean <- dfr %>% mutate_if(is.character, factor)
```


Summary & Barplot

```{r global summary}
summary(df_clean)
```

Pour une var

```{r city barplot}
df_clean %>% 
        count(City) %>%
        ggplot(aes(x = forcats::fct_reorder(City, .x = n), y = n)) +
        geom_bar(stat = "identity") +
        coord_flip()
```

Croisée quali / quali

```{r }
df_clean %>% 
        group_by(City, PriceRange) %>% 
        summarise(nb = n()) %>% 
        ggplot(aes(PriceRange, City, fill = nb)) +
        geom_tile() +
        scale_fill_gradient2()
```



```{r}
df_clean %>% 
        transmute(CookType1 = forcats::fct_lump(f = CookType1, prop = .01))

df_cook <- df_clean %>% 
        group_by(CookType1) %>% # CookType2
        summarise(nb = n(), m_rating = mean(Rating, na.rm = TRUE)) %>% 
        arrange(- nb) %>% 
        slice(1:20)

df_cook %>% 
        ggplot(aes(x = forcats::fct_reorder(CookType1, nb), y = nb)) + geom_col() + coord_flip()

df_cook %>% 
        ggplot(aes(x = forcats::fct_reorder(CookType1, m_rating), y = m_rating)) + geom_col() + coord_flip()


# df_p <- df_clean %>% 
#         group_by(CookType1) %>% # CookType2
#         summarise(nb = n(), m_rating = mean(Rating, na.rm = TRUE)) %>% 
#         arrange(- nb) %>% 
#         slice(1:20)

# ggplot(df_p, aes(x = CookType1, y = nb)) + geom_col() + coord_flip()
```


```{r}
# boxplot notes / type de cuisine (+ par villes ?)

# boxplot notes / type de resto (+ par villes ?)
df_clean %>% 
        ggplot(aes(x = Category, y =Rating)) +
        geom_boxplot() +
        coord_flip()

df_cat <- df_clean %>% 
        filter(Category %in% c("Street", "Steakhouse"))
t.test(Rating ~ Category, data = df_cat)
```


```{r}
lm_mod <- lm(Rating ~ 0 + Category, data = df_clean)
lm_mod
summary(lm_mod)

anova(lm_mod)
```


```{r}
glimpse(df_clean)
df_mod <- df_clean[, -c(1:2, 10:11, 14, 16:17)]
glimpse(df_mod)
lm_mod2 <- lm(Rating ~ 0 + City + CookType1 + Category + PriceRange + NumberOfReviews, data = df_clean)
summary(lm_mod2)
```


```{r}
#  NumberOfReviews ---> rating ?
```


